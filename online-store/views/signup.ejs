<!DOCTYPE html>
<html>
  <head>
    <title>Starbucks Online Store</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css"
    />
    <script
      src="https://www.gstatic.com/firebasejs/8.4.3/firebase-app.js"
      defer
    ></script>
    <script
      src="https://www.gstatic.com/firebasejs/8.4.3/firebase-auth.js"
      defer
    ></script>
  </head>
  <body>
    <main>
      <form id="signin">
        <fieldset id="sign_up" class="ba b--transparent ph0 mh0">
          <legend class="ph0 mh0 fw6 clip">Sign Up</legend>
          <div class="mt3">
            <label class="db fw4 lh-copy f6" for="email">Email address</label>
            <input
              class="pa2 input-reset ba bg-transparent w-100 measure"
              type="email"
              name="email"
              id="email"
            />
          </div>
          <div class="mt3">
            <label class="db fw4 lh-copy f6" for="password">Password</label>
            <input
              class="b pa2 input-reset ba bg-transparent"
              type="password"
              name="password"
              id="password"
            />
          </div>
        </fieldset>
        <button>Sign up</button>
      </form>
      <script>
        window.addEventListener('DOMContentLoaded', () => {
          var firebaseConfig = {
            apiKey: 'AIzaSyA9TbKO5ICQ9Axzj4hlycGtVwTAZTJNz6E',
            authDomain: 'starbucks-online-store.firebaseapp.com',
            projectId: 'starbucks-online-store',
            storageBucket: 'starbucks-online-store.appspot.com',
            messagingSenderId: '192573308957',
            appId: '1:192573308957:web:6f01ac7a0ea1a920c0c6f4',
            measurementId: 'G-0J40M88H1G',
          };
          // Initialize Firebase
          firebase.initializeApp(firebaseConfig);
          firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE);

          document
            .getElementById('signin')
            .addEventListener('submit', (event) => {
              event.preventDefault();
              const email = event.target.email.value;
              const password = event.target.password.value;

              firebase
                .auth()
                .createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                  let user = userCredential.user;
                  return user.getIdToken().then((idToken) => {
                    return fetch('/login', {
                      method: 'POST',
                      headers: {
                        Accept: 'application/json',
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({ idToken }),
                    });
                  });
                })
                .then(() => {
                  return firebase.auth().signOut();
                })
                .then(() => {
                  console.log('redirecting');
                  window.location.replace('/profile');
                });
            });
        });
      </script>
    </main>
  </body>
</html>
